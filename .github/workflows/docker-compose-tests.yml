# Pytest: Verify that functionality works as expected.
# Runs all test in the dds_web by executing the docker compose yml files for testing.
# The actual pytest command is not in this file.
# ---
# Action failing? Manually fix any errors locally.
#   - Follow the instructions in the "Run tests" section of the README.md to run the tests locally.
#   - Additional info:  The PR should ALWAYS include new tests or fixed tests when there are code changes.
#     When pytest action has finished, it will post a codecov report;
#     Look at this report and verify the files you have changed are listed.
#     "90% <100.00%> (+0.8%)" means "Tests cover 90% of the changed file,
#     <100 % of this PR's code changes are tested>, and (the code changes
#     and added tests increased the overall test coverage with 0.8%)
---
name: Pytest

on:
  push:
    branches: [dev, master]
  pull_request:
  workflow_dispatch:

jobs:
  pytest:
    concurrency:
      group: ${{ github.ref }}-pytest
      cancel-in-progress: true
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tests against database container
        run: |
          pip install -r tests/requirements-test.txt
          docker compose -f docker-compose.yml \
            -f tests/docker-compose-test.yml up \
            --build --exit-code-from backend

      - name: Setup upterm session
        uses: lhotari/action-upterm@v1
        if: ${{ failure() }}
        with:
          ## If no one connects after 5 minutes, shut down server.
          wait-timeout-minutes: 5

      - uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/report.xml
